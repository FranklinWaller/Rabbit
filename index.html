<!DOCTYPE html>
<html>
    <head>
        <title>Boilerplayer</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.5.3/cytoscape.min.js"></script>
        <style>
            * {
                font-family: 'Open Sans';
            }
        </style>
    </head>
    <body>
        <div id="dagspace" style="height: 500px;"></div>
        <h1>Rutile testing environment</h1>
        <section>
            <div>
                <label>Private Key:</label>
                <input type="text" id="privateKey" value="C0DEC0DEC0DEC0DEC0DEC0DEC0DEC0DEC0DEC0DEC0DEC0DEC0DEC0DEC0DEC0DE" />
            </div>
            <div>
                <label>Address:</label>
                <span id="address">0x0000000000000000000000000000</span>
            </div>
            <div>
                <label>Balance:</label>
                <span id="balance">?</span>
            </div>
            <div>
                Is Rutile active? <span id="isRutileActive">No</span>
            </div>
            <button onclick="setPrivateKey()">Set private key</button>
        </section>
        <h1>Balance of Address</h1>
        <section>
            <div>
                <label>Address:</label>
                <input type="text" id="addressInfo" value="0x53ae893e4b22d707943299a8d0c844df0e3d5557" />
                <div>
                    <label>Balance:</label>
                    <span id="balanceInfo">?</span>
                </div>
            </div>
            <button onclick="getAddressInfo()">Get addresss info</button>
        </section>
        <h2>RUT sending</h2>
        <section>
            <div>
                <label>Address</label>
                <input type="text" id="valueAddressTo" value="0x0200000000000000000000000000000000000000" />
            </div>
            <div>
                <label>Value</label>
                <input type="number" id="valueAddress" value="32" />RUT
            </div>
            <div>
                <label>Data</label>
                <input type="text" id="valueData" value="0x00000001" />
            </div>
            <button onclick="sendValue()">Send transaction</button>
        </section>
        <h2>Snapshot creator</h2>
        <section>
            <div>
                <label>Transaction ID</label>
                <input type="text" id="blockSnapshotId" value="0x" />
            </div>
            <button onclick="takeSnapshot()">Take Snapshot</button>
        </section>
        <h2>Upload file to local IPFS Node</h2>
        <section>
            <div>
                <label>File</label>
                <input type="file" id="valueFile" />
            </div>
        </section>
        <h2>Register as host for a local ipfs file</h2>
        <section>
            <div>
                <label>Hash of file</label>
                <input type="text" id="valueHash"/>
            </div>
            <button onclick="RegisterAsHost()">Register as host</button>
        </section>

        <div id="app"></div>
        <script src="build/rutile.js" charset="utf-8"></script>
        <script>
            let rutile = null;
            let keyPair = null;
            let cy = null;


            async function takeSnapshot() {
                const blockId = document.getElementById('blockSnapshotId').value;

                await Rutile.Snapshot.takeSnapshot(blockId);
            }

            async function run() {
                try {
                    rutile = new Rutile();
                    await rutile.start();
                    rutile.dag.on('transactionAdded', (event) => {
                        addTransaction(event.transaction)
                    });

                    setPrivateKey();
                    getAddressInfo();

                    document.getElementById('isRutileActive').innerHTML = 'Yes';
                } catch (error) {
                    console.error(error);
                    document.getElementById('isRutileActive').innerHTML = 'Error';
                }
            }

            async function getAddressInfo() {
                const address = document.getElementById('addressInfo').value;
                document.getElementById('balanceInfo').innerHTML = 'calculating..';

                const account = await Rutile.Account.getFromAddress(address);
                const balance = await rutile.getAccountBalance(address);

                document.getElementById('balanceInfo').innerHTML = balance;
            }

            function convertToHex(str) {
                var hex = '';
                for(var i=0;i<str.length;i++) {
                    hex += ''+str.charCodeAt(i).toString(16);
                }
                return hex;
            }

            async function uploadFileToLocalIPFS(evt) {
                var f = evt.target.files[0]; 
                if (f) {
                var r = new FileReader();
                r.onload = async function(e) { 
                    var content = e.target.result;
                    var hash = await rutile.Ipfs.add(content);

                    const privateKey = document.getElementById('privateKey').value;
                    const toAddress = '0x0300000000000000000000000000000000000000';
                    const value = '1';
                    const data = '0x00000001' + convertToHex(hash);
                    const keyPair = new Rutile.KeyPair(privateKey);
                    const account = await Rutile.Account.getFromAddress(keyPair.getAddress());
                    let transIndex = account.transactionIndex + 1;

                    const transaction = new Rutile.Transaction({
                        to: toAddress,
                        value,
                        data,
                        nonce: transIndex,
                    });

                    transaction.sign(keyPair);

                    const results = await transaction.execute();
                    const result = await rutile.sendTransaction(transaction, wallet.keyPair);
                }
                r.readAsText(f);
                } else { 
                    alert("Failed to load file");
                }
            }
            async function RegisterAsHost(){
                const hash = document.getElementById('valueHash').value;
                const privateKey = document.getElementById('privateKey').value;
                const toAddress = '0x0300000000000000000000000000000000000000';
                const value = '1';
                const data = '0x00000002' + convertToHex(hash);
                const keyPair = new Rutile.KeyPair(privateKey);
                const account = await Rutile.Account.getFromAddress(keyPair.getAddress());
                let transIndex = account.transactionIndex + 1;

                const transaction = new Rutile.Transaction({
                    to: toAddress,
                    value,
                    data,
                    nonce: transIndex,
                });

                transaction.sign(keyPair);

                const results = await transaction.execute();
                const result = await rutile.sendTransaction(transaction, wallet.keyPair);
            }

            document.getElementById('valueFile').addEventListener('change', uploadFileToLocalIPFS, false);

            async function setPrivateKey() {
                keyPair = new Rutile.Wallet(document.getElementById('privateKey').value);
                const account = await keyPair.getAccountInfo();

                document.getElementById('address').innerHTML = account.address;
                document.getElementById('balance').innerHTML = account.balance;
            }

            async function sendValue() {
                const privateKey = document.getElementById('privateKey').value;
                const toAddress = document.getElementById('valueAddressTo').value;
                const value = document.getElementById('valueAddress').value;
                const data = document.getElementById('valueData').value;

                const keyPair = new Rutile.KeyPair(privateKey);
                const account = await Rutile.Account.getFromAddress(keyPair.getAddress());
                let transIndex = account.transactionIndex + 1;

                const transaction = new Rutile.Transaction({
                    to: toAddress,
                    value,
                    data,
                    transIndex,
                });

                const txResult = await rutile.sendTransaction(transaction, keyPair);

                console.log('[] txResult -> ', txResult);
            }

            function addTransaction(transaction) {
                return;
                const toAdd = [];

                toAdd.push({
                    group: 'nodes',
                    data: {
                        id: transaction.id,
                    }
                });

                if (transaction.parents.length) {
                    transaction.parents.forEach((tx) => {
                        links.push({
                            data: {
                                source: transaction.id,
                                target: tx,
                                id: transaction.id + tx,
                            }
                        });
                    });
                }

                cy.add(toAdd);
            }

            async function runD3() {
                const transactions = (await Rutile.Database.databaseFind('gasLimit', 0)).docs.sort((a, b) => a.timestamp - b.timestamp);
                const elements = [];
                const links = [];

                for (let index = 0; index < transactions.length; index++) {
                    const transaction = transactions[index];

                    elements.push({
                        data: {
                            id: transaction.id,
                        }
                    });

                    if (transaction.parents.length) {
                        transaction.parents.forEach((tx) => {
                            links.push({
                                data: {
                                    source: transaction.id,
                                    target: tx,
                                    id: transaction.id + tx,
                                }
                            });
                        });
                    }
                }

                cy = cytoscape({
                    group: 'edges',
                    container: document.getElementById('dagspace'),
                    elements: {
                        nodes: elements,
                        edges: links,
                    },
                    layout: {
                        name: 'cose',
                        // rows: 1,
                    },
                    style: [
                        {
                            selector: 'node',
                            style: {
                                // 'label': 'data(id)'
                            }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'width': 3,
                                'line-color': '#ccc',
                                'curve-style': 'bezier',
                                'target-arrow-color': '#ccc',
                                'target-arrow-shape': 'triangle' // there are far more options for this property here: http://js.cytoscape.org/#style/edge-arrow
                            }
                        }
                    ]
                });
            }

            run();
            runD3();
        </script>
        <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    </body>
</html>
